<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vDraw - Welcome</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="auth-container">
        <h1>vDraw</h1>
        <p>Your collaborative whiteboard.</p>
        
        <div class="auth-form" id="login-form">
            <h2>Login</h2>
            <input type="text" id="login-username" placeholder="Username">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-btn">Login</button>
            <p>Don't have an account? <a href="#" id="show-register">Register here</a></p>
        </div>

        <div class="auth-form" id="register-form" style="display:none;">
            <h2>Register</h2>
            <input type="text" id="register-username" placeholder="Username">
            <input type="password" id="register-password" placeholder="Password">
            <button id="register-btn">Register</button>
            <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
        </div>

        <div class="room-actions" id="room-actions" style="display:none;">
            <h2>Welcome, <span id="welcome-username"></span>!</h2>
            <input type="text" id="room-id-input" placeholder="Enter Room ID to Join" maxlength="6">
            <button id="join-room-btn">Join Room</button>
            <p class="separator">or</p>
            <button id="create-room-btn">Create a New Room</button>
        </div>
        <div id="error-message" class="error"></div>
    </div>
    
    <script>
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const roomActions = document.getElementById('room-actions');
        const errorMessage = document.getElementById('error-message');

        let currentUser = null;

        // Check if user is already logged in (using sessionStorage)
        const loggedInUser = sessionStorage.getItem('vdraw_user');
        if (loggedInUser) {
            currentUser = JSON.parse(loggedInUser);
            showRoomActions();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }

        function showRoomActions() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            roomActions.style.display = 'block';
            document.getElementById('welcome-username').textContent = currentUser.username;
        }

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            hideError();
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            hideError();
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (response.ok) {
                currentUser = data;
                sessionStorage.setItem('vdraw_user', JSON.stringify(currentUser));
                showRoomActions();
                hideError();
            } else {
                showError(data.message);
            }
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (response.ok) {
                // Auto-login after successful registration
                currentUser = data;
                sessionStorage.setItem('vdraw_user', JSON.stringify(currentUser));
                showRoomActions();
                hideError();
            } else {
                showError(data.message);
            }
        });

        document.getElementById('create-room-btn').addEventListener('click', () => {
            if (!currentUser) return alert('Please log in first.');
            // We use a temporary socket connection just to create the room
            const tempSocket = io();
            tempSocket.on('connect', () => {
                tempSocket.emit('authenticate', currentUser);
                tempSocket.emit('create-room', (response) => {
                    if (response.success) {
                        window.location.href = `/board.html?room=${response.roomId}`;
                    } else {
                        showError('Could not create room.');
                    }
                    tempSocket.disconnect();
                });
            });
        });

        document.getElementById('join-room-btn').addEventListener('click', () => {
            const roomId = document.getElementById('room-id-input').value.trim().toUpperCase();
            if (roomId.length === 6) {
                window.location.href = `/board.html?room=${roomId}`;
            } else {
                showError('Please enter a valid 6-character room ID.');
            }
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
</body>
</html>